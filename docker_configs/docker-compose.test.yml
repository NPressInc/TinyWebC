version: '3.8'
services:
  tailscale_node_01:
    image: tailscale/tailscale:latest
    environment:
      TS_AUTHKEY: ${TS_AUTHKEY}
      TS_HOSTNAME: tw_node01
      TS_STATE_DIR: /var/lib/tailscale
    volumes:
    - tailscale_node_01_state:/var/lib/tailscale
    cap_add:
    - NET_ADMIN
    healthcheck:
      test:
      - CMD
      - tailscale
      - status
      - --json
      interval: 10s
      timeout: 5s
      retries: '3'
      start_period: 30s
    restart: 'no'
  tailscale_node_02:
    image: tailscale/tailscale:latest
    environment:
      TS_AUTHKEY: ${TS_AUTHKEY}
      TS_HOSTNAME: tw_node02
      TS_STATE_DIR: /var/lib/tailscale
    volumes:
    - tailscale_node_02_state:/var/lib/tailscale
    cap_add:
    - NET_ADMIN
    healthcheck:
      test:
      - CMD
      - tailscale
      - status
      - --json
      interval: 10s
      timeout: 5s
      retries: '3'
      start_period: 30s
    restart: 'no'
  tailscale_node_03:
    image: tailscale/tailscale:latest
    environment:
      TS_AUTHKEY: ${TS_AUTHKEY}
      TS_HOSTNAME: tw_node03
      TS_STATE_DIR: /var/lib/tailscale
    volumes:
    - tailscale_node_03_state:/var/lib/tailscale
    cap_add:
    - NET_ADMIN
    healthcheck:
      test:
      - CMD
      - tailscale
      - status
      - --json
      interval: 10s
      timeout: 5s
      retries: '3'
      start_period: 30s
    restart: 'no'
  tailscale_node_04:
    image: tailscale/tailscale:latest
    environment:
      TS_AUTHKEY: ${TS_AUTHKEY}
      TS_HOSTNAME: tw_node04
      TS_STATE_DIR: /var/lib/tailscale
    volumes:
    - tailscale_node_04_state:/var/lib/tailscale
    cap_add:
    - NET_ADMIN
    healthcheck:
      test:
      - CMD
      - tailscale
      - status
      - --json
      interval: 10s
      timeout: 5s
      retries: '3'
      start_period: 30s
    restart: 'no'
  node_node_01:
    build:
      context: .
      dockerfile: scripts/Dockerfile.node
    environment:
      TINYWEB_NODE_ID: '1'
      TINYWEB_DISCOVERY_MODE: tailscale
    volumes:
    - docker_configs/node_01/state:/app/state
    healthcheck:
      test:
      - CMD-SHELL
      - curl -f http://localhost:8000/health || exit 1
      interval: 30s
      timeout: 10s
      retries: '3'
      start_period: 40s
    restart: 'no'
    network_mode: service:tailscale_node_01
    depends_on:
      tailscale_node_01:
        condition: service_healthy
  node_node_02:
    build:
      context: .
      dockerfile: scripts/Dockerfile.node
    environment:
      TINYWEB_NODE_ID: '2'
      TINYWEB_DISCOVERY_MODE: tailscale
    volumes:
    - docker_configs/node_02/state:/app/state
    healthcheck:
      test:
      - CMD-SHELL
      - curl -f http://localhost:8000/health || exit 1
      interval: 30s
      timeout: 10s
      retries: '3'
      start_period: 40s
    restart: 'no'
    network_mode: service:tailscale_node_02
    depends_on:
      tailscale_node_02:
        condition: service_healthy
  node_node_03:
    build:
      context: .
      dockerfile: scripts/Dockerfile.node
    environment:
      TINYWEB_NODE_ID: '3'
      TINYWEB_DISCOVERY_MODE: tailscale
    volumes:
    - docker_configs/node_03/state:/app/state
    healthcheck:
      test:
      - CMD-SHELL
      - curl -f http://localhost:8000/health || exit 1
      interval: 30s
      timeout: 10s
      retries: '3'
      start_period: 40s
    restart: 'no'
    network_mode: service:tailscale_node_03
    depends_on:
      tailscale_node_03:
        condition: service_healthy
  node_node_04:
    build:
      context: .
      dockerfile: scripts/Dockerfile.node
    environment:
      TINYWEB_NODE_ID: '4'
      TINYWEB_DISCOVERY_MODE: tailscale
    volumes:
    - docker_configs/node_04/state:/app/state
    healthcheck:
      test:
      - CMD-SHELL
      - curl -f http://localhost:8000/health || exit 1
      interval: 30s
      timeout: 10s
      retries: '3'
      start_period: 40s
    restart: 'no'
    network_mode: service:tailscale_node_04
    depends_on:
      tailscale_node_04:
        condition: service_healthy
volumes:
  tailscale_node_01_state: {}
  tailscale_node_02_state: {}
  tailscale_node_03_state: {}
  tailscale_node_04_state: {}
