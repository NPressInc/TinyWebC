services:
  tailscale_node_01:
    image: ! 'tailscale/tailscale:latest'
    environment:
      TS_AUTHKEY: ! '${TS_AUTHKEY_01}'
      TS_HOSTNAME: ! 'tw-node01'
      TS_STATE_DIR: ! '/var/lib/tailscale'
    volumes:
    - tailscale_node_01_state:/var/lib/tailscale
    cap_add:
    - NET_ADMIN
    healthcheck:
      test:
      - CMD
      - tailscale
      - status
      - --json
      interval: ! '10s'
      timeout: ! '5s'
      retries: ! '3'
      start_period: ! '30s'
    restart: ! 'no'
  tailscale_node_02:
    image: ! 'tailscale/tailscale:latest'
    environment:
      TS_AUTHKEY: ! '${TS_AUTHKEY_02}'
      TS_HOSTNAME: ! 'tw-node02'
      TS_STATE_DIR: ! '/var/lib/tailscale'
    volumes:
    - tailscale_node_02_state:/var/lib/tailscale
    cap_add:
    - NET_ADMIN
    healthcheck:
      test:
      - CMD
      - tailscale
      - status
      - --json
      interval: ! '10s'
      timeout: ! '5s'
      retries: ! '3'
      start_period: ! '30s'
    restart: ! 'no'
  tailscale_node_03:
    image: ! 'tailscale/tailscale:latest'
    environment:
      TS_AUTHKEY: ! '${TS_AUTHKEY_03}'
      TS_HOSTNAME: ! 'tw-node03'
      TS_STATE_DIR: ! '/var/lib/tailscale'
    volumes:
    - tailscale_node_03_state:/var/lib/tailscale
    cap_add:
    - NET_ADMIN
    healthcheck:
      test:
      - CMD
      - tailscale
      - status
      - --json
      interval: ! '10s'
      timeout: ! '5s'
      retries: ! '3'
      start_period: ! '30s'
    restart: ! 'no'
  tailscale_node_04:
    image: ! 'tailscale/tailscale:latest'
    environment:
      TS_AUTHKEY: ! '${TS_AUTHKEY_04}'
      TS_HOSTNAME: ! 'tw-node04'
      TS_STATE_DIR: ! '/var/lib/tailscale'
    volumes:
    - tailscale_node_04_state:/var/lib/tailscale
    cap_add:
    - NET_ADMIN
    healthcheck:
      test:
      - CMD
      - tailscale
      - status
      - --json
      interval: ! '10s'
      timeout: ! '5s'
      retries: ! '3'
      start_period: ! '30s'
    restart: ! 'no'
  node_01:
    build:
      context: ! '..'
      dockerfile: ! 'scripts/Dockerfile.node'
    environment:
      TINYWEB_NODE_ID: ! '1'
      TINYWEB_DISCOVERY_MODE: ! 'tailscale'
    volumes:
    - ./node_01/state/keys:/app/state/keys
    - node_01_storage:/app/state/storage
    healthcheck:
      test:
      - CMD-SHELL
      - ! 'curl -f http://localhost:8000/health || exit 1'
      interval: ! '30s'
      timeout: ! '10s'
      retries: ! '3'
      start_period: ! '40s'
    restart: ! 'no'
    network_mode: ! 'service:tailscale_node_01'
    depends_on:
      tailscale_node_01:
        condition: ! 'service_healthy'
  node_02:
    build:
      context: ! '..'
      dockerfile: ! 'scripts/Dockerfile.node'
    environment:
      TINYWEB_NODE_ID: ! '2'
      TINYWEB_DISCOVERY_MODE: ! 'tailscale'
    volumes:
    - ./node_02/state/keys:/app/state/keys
    - node_02_storage:/app/state/storage
    healthcheck:
      test:
      - CMD-SHELL
      - ! 'curl -f http://localhost:8000/health || exit 1'
      interval: ! '30s'
      timeout: ! '10s'
      retries: ! '3'
      start_period: ! '40s'
    restart: ! 'no'
    network_mode: ! 'service:tailscale_node_02'
    depends_on:
      tailscale_node_02:
        condition: ! 'service_healthy'
  node_03:
    build:
      context: ! '..'
      dockerfile: ! 'scripts/Dockerfile.node'
    environment:
      TINYWEB_NODE_ID: ! '3'
      TINYWEB_DISCOVERY_MODE: ! 'tailscale'
    volumes:
    - ./node_03/state/keys:/app/state/keys
    - node_03_storage:/app/state/storage
    healthcheck:
      test:
      - CMD-SHELL
      - ! 'curl -f http://localhost:8000/health || exit 1'
      interval: ! '30s'
      timeout: ! '10s'
      retries: ! '3'
      start_period: ! '40s'
    restart: ! 'no'
    network_mode: ! 'service:tailscale_node_03'
    depends_on:
      tailscale_node_03:
        condition: ! 'service_healthy'
  node_04:
    build:
      context: ! '..'
      dockerfile: ! 'scripts/Dockerfile.node'
    environment:
      TINYWEB_NODE_ID: ! '4'
      TINYWEB_DISCOVERY_MODE: ! 'tailscale'
    volumes:
    - ./node_04/state/keys:/app/state/keys
    - node_04_storage:/app/state/storage
    healthcheck:
      test:
      - CMD-SHELL
      - ! 'curl -f http://localhost:8000/health || exit 1'
      interval: ! '30s'
      timeout: ! '10s'
      retries: ! '3'
      start_period: ! '40s'
    restart: ! 'no'
    network_mode: ! 'service:tailscale_node_04'
    depends_on:
      tailscale_node_04:
        condition: ! 'service_healthy'
volumes:
  node_01_storage: {}
  node_02_storage: {}
  node_03_storage: {}
  node_04_storage: {}
  tailscale_node_01_state: {}
  tailscale_node_02_state: {}
  tailscale_node_03_state: {}
  tailscale_node_04_state: {}
